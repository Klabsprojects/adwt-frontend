      <div class="loader-overlay" *ngIf="loader">
       <mat-spinner></mat-spinner>
      </div>
      <!-- <h1 class="text-center mt-3 mb-5">MRF Abstract Report</h1> -->
<div class="card px-8 mt-5">
  <div class="card-header border-0 pt-6 p-0">
    <div class="card-title">
      <div class="d-flex align-items-center position-relative my-1">
        <i class="fas fa-search fs-3 position-absolute ms-5"></i>
        <input type="text" [(ngModel)]="searchText" 
          class="form-control form-control-solid w-250px ps-12" placeholder="Search Reports" />
      </div>
    </div>
    <!-- Drop List for columns -->
    <div class="toolbar mb-3">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Select Columns</mat-label>
        <mat-select [(ngModel)]="selectedColumns" (selectionChange)="onColumnSelectionChange()" multiple>
          <mat-option *ngFor="let column of displayedColumns" [value]="column.field">
            {{ column.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

  </div>

  <div class="row d-flex mb-3 align-items-center outer pt-4 pb-2 px-3 m-0">
      <div class="col-xl-3 col-lg-3 col-md-4 mb-3" *ngIf="Parsed_UserInfo.access_type != 'District'">
        <select class="form-select" [(ngModel)]="selectedDistrict">
          <option value="" selected>District</option>
          <option *ngFor="let district of districts" [value]="district">{{ district }}</option>
        </select>
      </div>

        <div class="col-xl-3 col-lg-3 col-md-4 mb-3">
        <select name="" id="" [(ngModel)]="selectedPoliceCity" class="form-select">
          <option value="">Police City</option>
          <option [value]="city.police_city" *ngFor="let city of policeCities">{{city.police_city}}</option>
        </select>
      </div>

        <div class="col-xl-3 col-lg-3 col-md-4 mb-3">
        <select name="" id="" [(ngModel)]="selectedZone" class="form-select">
          <option value="">Police Zone</option>
          <option [value]="zone.police_zone" *ngFor="let zone of zones">{{zone.police_zone}}</option>
        </select>
      </div>

        <!-- <div class="col-xl-3 col-lg-3 col-md-4 mb-3">
        <select name="" id="" [(ngModel)]="selectedCommunity" (change)="getCaste()" class="form-select" (change)="applyFilters()">
          <option value="">Community</option>
          <option [value]="community" *ngFor="let community of communities">{{community}}</option>
        </select>
      </div>
      <div class="col-xl-3 col-lg-3 col-md-4 mb-3">
        <select class="form-select" [(ngModel)]="selectedCaste" (change)="applyFilters()">
          <option value="" selected>Caste</option>
          <option *ngFor="let option of castes" [value]="option">
            {{ option }}
          </option>
        </select>
      </div> -->

      <div class="col-xl-3 col-lg-3 col-md-4 mb-3">
        <select class="form-select" [(ngModel)]="selectedStatus">
          <option value="" selected>Status Of Case</option>
          <option *ngFor="let option of status" [value]="option.key">
            {{ option.value }}
          </option>
        </select>
      </div>

      <div class="col-xl-3 col-lg-3 col-md-4 mb-3 tooltip-container">
        <input type="date" class="form-control" [(ngModel)]="selectedFromDate"/>
        <span class="tooltip-text">Date of Registration From Date</span>
      </div>
      <div class="col-xl-3 col-lg-3 col-md-4 mb-3 tooltip-container">
        <input type="date" class="form-control" [(ngModel)]="selectedToDate"/>
        <span class="tooltip-text">Date of Registration To Date</span>
      </div>
      <div class="col-xl-5 col-lg-3 col-md-4 mb-3">
        <button (click)="applyFilters()" class="btn btn-primary btn-sm">Apply Filters</button>
        <button (click)="clearfilter()" class="btn btn-secondary btn-sm" style="margin-left: 5px;">Clear</button>
      </div>
    </div>

  <div class="card-body p-0">
    <!-- Filters -->
    <!-- <div class="d-flex gap-3 mb-3">
      <select class="form-select" [(ngModel)]="selectedDistrict" (change)="applyFilters()">
        <option value="" selected>Select One</option>
        <option *ngFor="let district of districts" [value]="district">{{ district }}</option>
      </select>

      <select class="form-select" [(ngModel)]="selectedNatureOfOffence" (change)="applyFilters()">
        <option value="" selected>Select One</option>
        <option *ngFor="let nature of naturesOfOffence" [value]="nature">{{ nature }}</option>
      </select>

      <select class="form-select" [(ngModel)]="selectedStatusOfCase" (change)="applyFilters()">
        <option value="" selected>Select One</option>
        <option *ngFor="let status of statusesOfCase" [value]="status">{{ status }}</option>
      </select>

      <select class="form-select" [(ngModel)]="selectedStatusOfRelief" (change)="applyFilters()">
        <option value="" selected>Select One</option>
        <option *ngFor="let reliefStatus of statusesOfRelief" [value]="reliefStatus">
          {{ reliefStatus }}
        </option>
      </select>
    </div> -->

    <!-- <button style="margin-left: 5px;" class="btn btn-primary mt-3" (click)="onBtnExport()">Download as Excel</button>
      <button style="margin-left: 5px;" class="btn btn-danger mt-3" (click)="onBtnExportPDF()">
  Download as PDF
</button> -->


    <div class="card-body p-0 overflow-auto">
      <table class="table table-bordered table-responsive list-table mt-3">
  <thead>
  <tr>
    <th *ngFor="let col of ungroupedColumns" rowspan="2">{{ col.label }}</th>

    <th *ngFor="let groupName of groupOrder" 
        [attr.colspan]="groupedBySection[groupName]?.length" style="text-align: center;">
      {{ groupName }}
    </th>
  </tr>

  <tr>
    <ng-container *ngFor="let groupName of groupOrder">
      <th *ngFor="let col of groupedBySection[groupName]" style="background-color: #0da9bc !important;">{{ col.label }}</th>
    </ng-container>
  </tr>
</thead>
  <tbody>
  <tr *ngFor="let report of paginatedData(); let i = index"
      [ngClass]="{ 'table-row-odd': i % 2 === 0, 'table-row-even': i % 2 !== 0 }">
    <td *ngFor="let column of getVisibleColumns()">
      <ng-container [ngSwitch]="column.field">

        <span *ngSwitchCase="'revenue_district'" 
              style="float: left; ">
          {{ report[column.field] }}
        </span>

        <!-- Total Cases -->
        <span *ngSwitchCase="'total_cases'" 
              class="text-dark fw-bold"
              style="cursor: pointer;"
              (click)="openReliefPopup(report,'totalcase')">
          {{ report[column.field] }}
        </span>

        <!-- MF Cases -->
        <span *ngSwitchCase="'mf_cases'" 
            class="text-purple fw-bold"
            style="cursor: pointer;"
            (click)="openReliefPopup(report, 'mf')">
        {{ report[column.field] }}
      </span>

       <span *ngSwitchCase="'nonmf_case'" 
            class="text-primary fw-bold"
            style="cursor: pointer;"
            (click)="openReliefPopup(report, 'nonmf')">
        {{ report[column.field] }}
      </span>

      <span *ngSwitchCase="'notyetreceived'" 
            class="text-info fw-bold"
            style="cursor: pointer;"
            (click)="openReliefPopup(report, 'notyetreceived')">
        {{ report[column.field] }}
      </span>

        <!-- FIR Relief Given -->
        <span *ngSwitchCase="'fir_relief_given'" 
              class="text-success fw-bold"
              style="cursor: pointer;"
              (click)="openGivenPopup(report,'fir')">
          {{ report[column.field] }}
        </span>

        <!-- FIR Relief Pending -->
        <span *ngSwitchCase="'fir_relief_pending'" 
              class="text-danger fw-bold" 
              style="cursor: pointer;"
              (click)="openPendingPopup(report,'fir')">
          {{ report[column.field] }}
        </span>

        <!-- Chargesheet Relief Given -->
        <span *ngSwitchCase="'chargesheet_relief_given'" 
              class="text-success fw-bold"
              style="cursor: pointer;"
              (click)="openGivenPopup(report,'charge')">
          {{ report[column.field] }}
        </span>

        <!-- Chargesheet Relief Pending -->
        <span *ngSwitchCase="'chargesheet_relief_pending'" 
              class="text-danger fw-bold" 
              style="cursor: pointer;"
              (click)="openPendingPopup(report,'charge')">
          {{ report[column.field] }}
        </span>

        <!-- Trial Relief Given -->
        <span *ngSwitchCase="'trial_relief_given'" 
              class="text-success fw-bold"
              style="cursor: pointer;"
              (click)="openGivenPopup(report,'trial')">
          {{ report[column.field] }}
        </span>

        <!-- Trial Relief Pending -->
        <span *ngSwitchCase="'trial_relief_pending'" 
              class="text-danger fw-bold" 
              style="cursor: pointer;"
              (click)="openPendingPopup(report, 'trial')">
          {{ report[column.field] }}
        </span>

        <!-- Default -->
        <span *ngSwitchDefault>{{ report[column.field] }}</span>
      </ng-container>
    </td>
  </tr>

  <!-- Totals Row -->
  <tr class="fw-bold bg-light text-start" style="background-color: #e0f7f9 !important;">
    <td *ngFor="let column of getVisibleColumns()" style="text-align: right;">
      {{ totalRow[column.field] || '' }}
    </td>
  </tr>
  
</tbody>


</table>



      <!-- Show message if data is loading -->
      <div *ngIf="loading" class="alert alert-warning">Loading...</div>
      <!-- Show message if filtered data is empty -->
      <div *ngIf="filteredData.length === 0 && !loading" class="alert alert-warning">No FIR data available.</div>
      
     
      <nav *ngIf="filteredData.length > itemsPerPage" class="d-flex justify-content-end mt-3">
        <ul class="pagination">
          <li class="page-item" [class.disabled]="page === 1">
            <button class="page-link" (click)="previousPage()">Previous</button>
          </li>
          <li class="page-item" *ngFor="let pageNum of totalPagesArray()">
            <button class="page-link" (click)="goToPage(pageNum)" [class.active]="page === pageNum">
              {{ pageNum }}
            </button>
          </li>
          <li class="page-item" [class.disabled]="page === totalPages()">
            <button class="page-link" (click)="nextPage()">Next</button>
          </li>
        </ul>
      </nav>
       <div class="mt-3 float-right">
  <button class="btn btn-primary me-2 py-2 px-3" (click)="onBtnExport()">
    <i class="fas fa-download me-1"></i> Excel
  </button>
  <button class="btn btn-danger py-2 px-3" (click)="onBtnExportPDF()">
    <i class="fas fa-download me-1"></i> PDF
  </button>
</div>
    </div>

  </div>
</div>


  <div class="modal fade" id="reliefModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 1200px !important;">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">{{ selectedStage }}</h3>

          <button type="button" class="btn-close" (click)="closePopup()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <h5>
              <strong>District:</strong> {{ selectedDistrict }}
              <div class="d-flex justify-content-between align-items-center my-3">
              <input type="text" class="form-control w-25" placeholder="Search..." [(ngModel)]="tableSearchText">
              <button class="btn btn-success me-2 py-2 px-3" style="float: right; margin-bottom: 10px;" (click)="caseDetailsExport()">
                          <i class="fas fa-download me-1"></i> Excel</button>
          </div>
        </h5>
            
          </div>
          <div class="overflow-auto">
 <table class="table table-bordered table-responsive mt-3">
  <thead>
    <tr>
      <th rowspan="2">S.no</th>
      <th rowspan="2">FIR Number</th>
      <th rowspan="2">Police Station</th>
      <th rowspan="2">Date of Registration</th>
      

     
      <!-- <th *ngIf="showFIR" [attr.colspan]="Colspan" class="text-center">FIR</th>
      <th *ngIf="showChargesheet" [attr.colspan]="Colspan" class="text-center">Chargesheet</th>
      <th *ngIf="showTrial" [attr.colspan]="Colspan" class="text-center">Trial</th> -->
      <th *ngIf="showFIR" [attr.colspan]="showFirProposal ? 4 : 3" class="text-center">FIR</th>
<th *ngIf="showChargesheet" [attr.colspan]="showChargesheetProposal ? 4 : 3" class="text-center">Chargesheet</th>
<th *ngIf="showTrial" [attr.colspan]="showTrialProposal ? 4 : 3" class="text-center">Trial</th>


    </tr>
    <tr>
      <ng-container *ngIf="showFIR">
        <th>Proposal sent to DC</th>
        <th>Status</th>
        <th (click)="sortTablePopup('fir')" style="cursor:pointer">
          Days Pending Since FIR Filing
        <span *ngIf="sortColumn==='fir'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
        </th>
        <th *ngIf="showFirProposal">Days Pending Since Proposal signing</th>
      </ng-container>

      <ng-container *ngIf="showChargesheet">
        <th>Proposal sent to DC</th>
        <th>Status</th>
        <th (click)="sortTablePopup('chargesheet')" style="cursor:pointer">
          Days Pending Since FIR Filing
        <span *ngIf="sortColumn==='chargesheet'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
        </th>
        <th *ngIf="showChargesheetProposal">Days Pending Since Proposal signing</th>
      </ng-container>

      <ng-container *ngIf="showTrial">
        <th>Proposal sent to DC</th>
        <th>Status</th>
        <th (click)="sortTablePopup('trial')" style="cursor:pointer">
          Days Pending Since FIR Filing
          <span *ngIf="sortColumn==='trial'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
        </th>
        <th *ngIf="showTrialProposal">Days Pending Since Proposal signing</th>
      </ng-container>
    </tr>
  </thead>

  <tbody>
    <tr *ngFor="let d of tableFilteredData() | slice:(currentPage-1)*itemsPerPage:(currentPage)*itemsPerPage; let i = index">
      <td>{{ (currentPage-1)*itemsPerPage + i + 1 }}</td>
      <!-- <td>{{ d.fir_number_full }}</td> -->
       <td><a (click)="openModalFromAbstract(d)" class="text-primary fw-bold" style="cursor: pointer;">
        <span>{{ d.fir_number_full }}</span>
      </a></td>
      <td>{{ d.police_station }}</td>
      <td>{{ d.register_date | date:'dd/MM/yyyy' }}</td>

      <!-- FIR -->
      <ng-container *ngIf="showFIR">
        <td>{{ d.fir_proposal_status }}</td>
        <td class="status-column">{{ d.fir_status }}</td>
        <td [ngClass]="{'text-danger fw-bold': d.fir_status !== 'Relief Given' && d.fir_pending_days > 50}"
            style="text-align: center;">
          {{ d.fir_status === 'Relief Given' ? '-' : d.fir_pending_days }}
        </td>
        <!-- <td class="status-column" *ngIf="showFirProposal">{{ d.fir_proposal_pending_days }}</td> -->
      <td class="status-column text-center" *ngIf="showFirProposal" [ngClass]="{ 'text-danger fw-bold': d.fir_proposal_pending_days != null }" >
        {{ d.fir_proposal_pending_days != null ? d.fir_proposal_pending_days : '-' }}
      </td>
      </ng-container>

      <!-- Chargesheet -->
      <ng-container *ngIf="showChargesheet">
        <td>{{ d.chargesheet_proposal_status }}</td>
        <td class="status-column">{{ d.chargesheet_status }}</td>
        <td [ngClass]="{'text-danger  fw-bold': d.chargesheet_status !== 'Relief Given' && d.chargesheet_pending_days > 50}"
            style="text-align: center;">
          {{ d.chargesheet_status === 'Relief Given' ? '-' : d.chargesheet_pending_days }}
        </td>
        <!-- <td class="status-column" *ngIf="showChargesheetProposal">{{ d.chargesheet_proposal_pending_days }}</td> -->
      <td class="status-column text-center" *ngIf="showChargesheetProposal" [ngClass]="{ 'text-danger fw-bold': d.chargesheet_proposal_pending_days != null }">
        {{ d.chargesheet_proposal_pending_days != null ? d.chargesheet_proposal_pending_days : '-' }}
      </td>
      </ng-container>

      <!-- Trial -->
      <ng-container *ngIf="showTrial"> 
        <td>{{ d.trial_proposal_status }}</td>
        <td class="status-column">{{ d.trial_status }}</td>
        <td [ngClass]="{'text-danger  fw-bold': d.trial_status !== 'Relief Given' && d.trial_pending_days > 50}"
            style="text-align: center;">
          {{ d.trial_status === 'Relief Given' ? '-' : d.trial_pending_days }}
        </td>
        <!-- <td class="status-column" *ngIf="showTrialProposal">{{ d.trial_proposal_pending_days }}</td> -->
       <td class="status-column text-center" *ngIf="showTrialProposal" [ngClass]="{ 'text-danger fw-bold': d.trial_proposal_pending_days != null }">
        {{ d.trial_proposal_pending_days != null ? d.trial_proposal_pending_days : '-' }}
      </td>
      </ng-container>
    </tr>

    <!-- No Records Row -->
    <tr *ngIf="tableFilteredData().length === 0">
      <td [attr.colspan]="4 
          + (showFIR ? 4 : 0) 
          + (showChargesheet ? 4 : 0) 
          + (showTrial ? 4 : 0)" 
          class="text-center text-muted">
        No Records Found
      </td>
    </tr>
  </tbody>
</table>
</div>
  <div class="d-flex justify-content-between align-items-center mt-3">
  <small>
    Showing {{ (currentPage-1)*itemsPerPage+1 }} - 
    {{ Math.min(currentPage*itemsPerPage, tableFilteredData().length) }} 
    of {{ tableFilteredData().length }} records
  </small>

  <nav>
    <ul class="pagination pagination-sm mb-0">

      <!-- Start -->
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" (click)="changePage(1)">Start</a>
      </li>

      <!-- Previous -->
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" (click)="changePage(currentPage-1)">Previous</a>
      </li>

      <!-- Page numbers -->
      <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
        <a class="page-link" (click)="changePage(page)">{{ page }}</a>
      </li>

      <!-- Next -->
      <li class="page-item" [class.disabled]="currentPage === tableTotalPages().length">
        <a class="page-link" (click)="changePage(currentPage+1)">Next</a>
      </li>

      <!-- End -->
      <li class="page-item" [class.disabled]="currentPage === tableTotalPages().length">
        <a class="page-link" (click)="changePage(tableTotalPages().length)">End</a>
      </li>

    </ul>
  </nav>
  </div>



      </div>
    </div>
  </div>
</div>
<style>
  .loader-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.8);
  z-index: 99;
  display: flex;
  justify-content: center;
  align-items: center;
}

  .tooltip-container {
    position: relative;
    display: inline-block;
  }

  .tooltip-text {
    visibility: hidden;
    background-color: #333;
    color: #fff;
    text-align: center;
    padding: 6px 8px;
    border-radius: 5px;
    position: absolute;
    top: -35px;
    /* Position above the input */
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .tooltip-container:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
  }
</style>
